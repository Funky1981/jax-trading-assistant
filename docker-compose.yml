services:
  hindsight:
    build:
      context: ./services/hindsight
      dockerfile: docker/standalone/Dockerfile
      args:
        INCLUDE_API: "true"
        INCLUDE_CP: "false"
    environment:
      HINDSIGHT_API_HOST: 0.0.0.0
      HINDSIGHT_API_PORT: 8888
      HINDSIGHT_API_LOG_LEVEL: info
    ports:
      - "8888:8888"

  jax-memory:
    build:
      context: .
      dockerfile: services/jax-memory/Dockerfile
    environment:
      HINDSIGHT_URL: http://hindsight:8888
      PORT: 8090
    ports:
      - "8090:8090"
    depends_on:
      - hindsight

  ib-bridge:
    build:
      context: ./services/ib-bridge
      dockerfile: Dockerfile
    environment:
      HOST: 0.0.0.0
      PORT: 8092
      LOG_LEVEL: ${IB_LOG_LEVEL:-INFO}
      IB_GATEWAY_HOST: ${IB_GATEWAY_HOST:-host.docker.internal}
      IB_GATEWAY_PORT: ${IB_GATEWAY_PORT:-4002}
      IB_CLIENT_ID: ${IB_CLIENT_ID:-1}
      AUTO_CONNECT: ${IB_AUTO_CONNECT:-true}
      PAPER_TRADING: ${IB_PAPER_TRADING:-true}
    ports:
      - "8092:8092"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import requests; requests.get('http://localhost:8092/health')\""]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

  agent0-service:
    build:
      context: ./services/agent0-service
      dockerfile: Dockerfile
    environment:
      HOST: 0.0.0.0
      PORT: 8093
      LOG_LEVEL: ${AGENT0_LOG_LEVEL:-INFO}
      # LLM Provider Configuration (default: Ollama - FREE)
      AGENT0_LLM_PROVIDER: ${AGENT0_LLM_PROVIDER:-ollama}
      AGENT0_OLLAMA_HOST: ${AGENT0_OLLAMA_HOST:-http://host.docker.internal:11434}
      AGENT0_OLLAMA_MODEL: ${AGENT0_OLLAMA_MODEL:-phi3:3.8b}
      # Optional: OpenAI (paid)
      AGENT0_OPENAI_API_KEY: ${AGENT0_OPENAI_API_KEY:-}
      AGENT0_OPENAI_MODEL: ${AGENT0_OPENAI_MODEL:-gpt-4o-mini}
      # Optional: Anthropic (paid)
      AGENT0_ANTHROPIC_API_KEY: ${AGENT0_ANTHROPIC_API_KEY:-}
      AGENT0_ANTHROPIC_MODEL: ${AGENT0_ANTHROPIC_MODEL:-claude-3-haiku-20240307}
      # Optional: Anthropic (paid)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-claude-3-haiku-20240307}
      # Service connections
      MEMORY_SERVICE_URL: http://jax-memory:8090
      IB_BRIDGE_URL: http://ib-bridge:8092
    ports:
      - "8093:8093"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - jax-memory
      - ib-bridge
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8093/health"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 5

  jax-market:
    build:
      context: .
      dockerfile: services/jax-market/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://jax:jax@postgres:5432/jax}
      POLYGON_API_KEY: ${POLYGON_API_KEY:-}
      ALPACA_API_KEY: ${ALPACA_API_KEY:-}
      ALPACA_API_SECRET: ${ALPACA_API_SECRET:-}
      REDIS_URL: ${REDIS_URL:-}
    ports:
      - "8095:8095"
    depends_on:
      - postgres
      - ib-bridge
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8095/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  jax-signal-generator:
    build:
      context: .
      dockerfile: services/jax-signal-generator/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://jax:jax@postgres:5432/jax}
    ports:
      - "8096:8096"
    depends_on:
      - postgres
      - jax-orchestrator
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8096/health || exit 1"]
      interval: 60s
      timeout: 10s
      start_period: 30s
      retries: 3

  jax-trade-executor:
    build:
      context: .
      dockerfile: services/jax-trade-executor/Dockerfile
    environment:
      POSTGRES_DSN: ${DATABASE_URL:-postgresql://jax:jax@postgres:5432/jax}
      IB_BRIDGE_URL: ${IB_BRIDGE_URL:-http://ib-bridge:8092}
      RISK_PER_TRADE: ${RISK_PER_TRADE:-0.01}
      MAX_POSITION_PCT: ${MAX_POSITION_PCT:-0.20}
      MAX_OPEN_POSITIONS: ${MAX_OPEN_POSITIONS:-10}
      MAX_DAILY_LOSS: ${MAX_DAILY_LOSS:-0}
      ORDER_TYPE: ${ORDER_TYPE:-LMT}
      PORT: 8097
    ports:
      - "8097:8097"
    depends_on:
      - postgres
      - ib-bridge
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8097/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  jax-api:
    build:
      context: .
      dockerfile: services/jax-api/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://jax:jax@postgres:5432/jax}
      JWT_SECRET: ${JWT_SECRET:-insecure-dev-secret-change-in-production}
      JWT_EXPIRY: ${JWT_EXPIRY:-24h}
      JWT_REFRESH_EXPIRY: ${JWT_REFRESH_EXPIRY:-168h}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:5173,http://127.0.0.1:3000,http://127.0.0.1:5173}
      CORS_ALLOWED_METHODS: ${CORS_ALLOWED_METHODS:-GET,POST,PUT,DELETE,OPTIONS}
      CORS_ALLOWED_HEADERS: ${CORS_ALLOWED_HEADERS:-Content-Type,Authorization}
      CORS_ALLOW_CREDENTIALS: ${CORS_ALLOW_CREDENTIALS:-true}
      RATE_LIMIT_REQUESTS_PER_MINUTE: ${RATE_LIMIT_REQUESTS_PER_MINUTE:-100}
      RATE_LIMIT_REQUESTS_PER_HOUR: ${RATE_LIMIT_REQUESTS_PER_HOUR:-1000}
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      API_PORT: ${API_PORT:-8081}
      IB_BRIDGE_URL: ${IB_BRIDGE_URL:-http://ib-bridge:8092}
      AGENT0_SERVICE_URL: ${AGENT0_SERVICE_URL:-http://agent0-service:8093}
      TRADE_EXECUTOR_URL: ${TRADE_EXECUTOR_URL:-http://jax-trade-executor:8097}
      JAX_ORCHESTRATOR_URL: ${JAX_ORCHESTRATOR_URL:-http://jax-orchestrator:8091}
    ports:
      - "${API_PORT:-8081}:${API_PORT:-8081}"
    depends_on:
      - jax-memory
      - postgres
      - ib-bridge
      - agent0-service
      - jax-trade-executor

  jax-orchestrator:
    build:
      context: .
      dockerfile: services/jax-orchestrator/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://jax:jax@postgres:5432/jax}
    ports:
      - "8091:8091"
    depends_on:
      - postgres
      - jax-memory
      - agent0-service
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8091/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  jax-ingest:
    profiles:
      - jobs
    image: golang:1.22
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - ./data:/data
    command:
      - go
      - run
      - ./services/jax-ingest/cmd/jax-ingest
      - -input
      - /data/dexter.json
    depends_on:
      - jax-memory

  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-jax}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-jax}
      POSTGRES_DB: ${POSTGRES_DB:-jax}
    ports:
      - "5433:5432"
    volumes:
      - jax-postgres:/var/lib/postgresql/data
      - ./db/postgres/migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-jax} -d ${POSTGRES_DB:-jax}"]
      interval: 5s
      timeout: 3s
      retries: 5

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    depends_on:
      - jax-market
      - jax-signal-generator
      - jax-orchestrator
      - jax-trade-executor
      - jax-api

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3001:3000"
    volumes:
      - ./observability/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./observability/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards:ro

volumes:
  jax-postgres:
